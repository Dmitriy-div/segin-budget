<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Wallet</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --brand-dark: #0D294D;
            --brand-accent: #39CAB9;
            --brand-light: #FEFFFF;
        }
        body { background-color: var(--brand-dark); color: var(--brand-light); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card { background: rgba(254, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(254, 255, 255, 0.1); border-radius: 16px; }
        .btn-primary { background-color: var(--brand-accent); color: var(--brand-dark); font-weight: 700; }
        .skeleton { background: linear-gradient(90deg, #1a3a5f 25%, #244a7a 50%, #1a3a5f 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <div id="app" class="p-4 max-w-md mx-auto pb-24">
        
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Мои Рейсы</h1>
            <div class="w-10 h-10 rounded-full border-2 border-[#39CAB9] overflow-hidden">
                <img :src="userPhoto" alt="Avatar" v-if="userPhoto">
            </div>
        </header>

        <div v-if="loading" class="space-y-4">
            <div v-for="i in 3" class="h-32 rounded-2xl skeleton"></div>
        </div>

        <div v-if="!loading && activeTab === 'cadences'" class="animate__animated animate__fadeIn">
            <div v-for="item in cadences" :key="item.id" class="card p-4 mb-4 relative">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm opacity-60">{{ item.start }} — {{ item.end }}</p>
                        <h2 class="text-xl font-bold mt-1">{{ calculateDays(item.start, item.end) }} дней</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[#39CAB9] font-bold text-lg">{{ calculateMoney(item.start, item.end) }} €</p>
                    </div>
                </div>
                <button @click="deleteItem('cadences', item.id)" class="absolute top-2 right-2 opacity-30 hover:opacity-100 text-xs text-red-400">Удалить</button>
            </div>
            
            <button @click="showAddModal = true" class="btn-primary w-full py-4 rounded-2xl fixed bottom-20 left-0 right-0 mx-4 shadow-lg active:scale-95 transition-transform">
                + Добавить каденцию
            </button>
        </div>

        <div v-if="activeTab === 'expenses'" class="animate__animated animate__fadeIn">
            <div v-for="exp in expenses" :key="exp.id" class="card p-4 mb-3 flex justify-between items-center">
                <div>
                    <p class="font-bold">{{ exp.category }}</p>
                    <p class="text-xs opacity-50">{{ exp.date }}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold" :class="exp.currency === 'EUR' ? 'text-[#39CAB9]' : 'text-orange-400'">
                        {{ exp.amount }} {{ exp.currency === 'EUR' ? '€' : 'zł' }}
                    </p>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 h-16 bg-[#0D294D] border-t border-white/10 flex justify-around items-center">
            <button @click="activeTab = 'cadences'" :class="activeTab === 'cadences' ? 'text-[#39CAB9]' : 'opacity-50'">Рейсы</button>
            <button @click="activeTab = 'expenses'" :class="activeTab === 'expenses' ? 'text-[#39CAB9]' : 'opacity-50'">Расходы</button>
        </nav>

        <div v-if="showAddModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
            <div class="card w-full p-6 bg-[#0D294D]">
                <h3 class="text-xl mb-4">Новая каденция</h3>
                <input v-model="newCadence.start" type="date" class="w-full bg-white/10 p-3 rounded-lg mb-3">
                <input v-model="newCadence.end" type="date" class="w-full bg-white/10 p-3 rounded-lg mb-4">
                <div class="flex gap-2">
                    <button @click="showAddModal = false" class="flex-1 p-3 opacity-50">Отмена</button>
                    <button @click="addCadence" class="flex-1 btn-primary p-3 rounded-lg">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const tg = window.Telegram.WebApp;

        createApp({
            data() {
                return {
                    activeTab: 'cadences',
                    loading: true,
                    showAddModal: false,
                    userPhoto: tg.initDataUnsafe?.user?.photo_url || '',
                    cadences: [],
                    expenses: [],
                    newCadence: { start: '', end: '' },
                    apiUrl: 'https://script.google.com/macros/s/AKfycbyKflcNjg4EXz5-yfroVbqX5CPDN1tdrVqn4xefLiW9s_LNba5sdlYMH-UKfvFBEX2qZw/exec'
                }
            },
            mounted() {
                tg.expand();
                tg.ready();
                this.fetchData();
            },
            methods: {
                async fetchData() {
                    this.loading = true;
                    try {
                        const res = await fetch(`${this.apiUrl}?page=cadences`);
                        this.cadences = await res.json();
                        // Аналогично для расходов...
                    } catch (e) { console.error(e); }
                    this.loading = false;
                },
                calculateDays(s, e) {
                    const diff = new Date(e) - new Date(s);
                    return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
                },
                calculateMoney(s, e) {
                    return this.calculateDays(s, e) * 95;
                },
                async addCadence() {
                    tg.HapticFeedback.impactOccurred('medium');
                    // Здесь логика fetch POST в Google Sheets
                    this.showAddModal = false;
                    alert('Данные отправлены в таблицу!');
                },
                deleteItem(type, id) {
                    tg.HapticFeedback.notificationOccurred('warning');
                    // Логика удаления...
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
