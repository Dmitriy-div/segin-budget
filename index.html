<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trucker Analytics Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --dark: #0D294D; --accent: #39CAB9; --white: #FEFFFF; --radius: 20px; }
        body { font-family: -apple-system, sans-serif; background: var(--dark); color: var(--white); margin: 0; padding-bottom: 110px; }
        .card { background: rgba(254,255,255,0.08); margin: 12px 16px; padding: 18px; border-radius: var(--radius); border: 1px solid rgba(254,255,255,0.1); }
        .status-header { background: linear-gradient(135deg, #1a3e6b 0%, #0D294D 100%); padding: 25px 20px; border-bottom: 1px solid var(--accent); text-align: center; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(13,41,77,0.96); display: flex; padding: 12px 0 25px; border-top: 1px solid rgba(254,255,255,0.1); backdrop-filter: blur(15px); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: rgba(254,255,255,0.4); font-size: 11px; }
        .nav-item.active { color: var(--accent); }
        .btn-export { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 10px; font-size: 12px; margin: 0 16px; display: flex; align-items: center; gap: 8px; }
        canvas { max-width: 100%; margin-top: 15px; }
        .modal-sheet { position: fixed; bottom: 0; width: 100%; background: var(--dark); border-radius: 28px 28px 0 0; padding: 25px; transform: translateY(100%); transition: 0.3s; z-index: 2000; box-sizing: border-box; border-top: 2px solid var(--accent); }
        .modal-sheet.active { transform: translateY(0); }
        @media print { .nav-bar, .add-fab, .btn-export, #overlay { display: none !important; } .card { border: 1px solid #ccc; color: black; } body { background: white; color: black; } }
    </style>
</head>
<body>

    <div id="status-area" class="status-header"></div>

    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px;">
        <h1 id="pageTitle" style="margin: 0 20px; font-size: 24px;">–†–µ–π—Å—ã</h1>
        <button class="btn-export" onclick="exportToPDF()"><i data-lucide="download"></i> PDF</button>
    </div>

    <div id="app-content"></div>

    <div id="overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; z-index:1999;" onclick="closeModal()"></div>
    <div id="modal" class="modal-sheet"><div id="modalContent"></div></div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('cadences', this)"><i data-lucide="truck"></i><div>–†–µ–π—Å—ã</div></div>
        <div class="nav-item" onclick="switchTab('expenses', this)"><i data-lucide="wallet"></i><div>–ë—é–¥–∂–µ—Ç</div></div>
    </nav>

<script>
    const TG = window.Telegram.WebApp;
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxjsvpNl7_6L-V0ddoNJnS4fbmq9PTH_dgQnT1ZQ31kx1POm46J1cMulFBvvj_Hi3FU-g/exec"; 
    let currentTab = 'cadences', dataCache = { cadences: [], expenses: [] }, exchangeRate = 4.35;

    function init() {
        TG.expand();
        const local = localStorage.getItem('truck_data');
        if (local) { dataCache = JSON.parse(local); render(); }
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(`${SHEET_URL}?action=get_all`);
            dataCache = await res.json();
            exchangeRate = dataCache.rate;
            localStorage.setItem('truck_data', JSON.stringify(dataCache));
            render();
        } catch (e) { console.error(e); }
        lucide.createIcons();
    }

    function render() {
        renderStatus();
        const cont = document.getElementById('app-content');
        if (currentTab === 'cadences') renderCadences(cont);
        else renderExpenses(cont);
        lucide.createIcons();
    }

    function renderStatus() {
        const now = new Date().toISOString().split('T')[0];
        const activeCadence = dataCache.cadences.find(c => now >= c.StartDate && now <= c.EndDate);
        const area = document.getElementById('status-area');

        if (activeCadence) {
            const daysLeft = Math.ceil((new Date(activeCadence.EndDate) - new Date()) / 86400000);
            area.innerHTML = `
                <div style="font-size: 14px; opacity: 0.8;">–í –†–ï–ô–°–ï</div>
                <div style="font-size: 32px; font-weight: 900; color: var(--accent); margin: 5px 0;">–î–æ–º–æ–π —á–µ—Ä–µ–∑ ${daysLeft} –¥–Ω.</div>
                <div style="font-size: 12px; opacity: 0.6;">–§–∏–Ω–∏—à: ${activeCadence.EndDate}</div>
            `;
        } else {
            area.innerHTML = `
                <div style="font-size: 40px;">üå¥</div>
                <div style="font-size: 28px; font-weight: 900; color: #FFD700;">–û–¢–ü–£–°–ö</div>
                <div style="font-size: 14px; opacity: 0.6;">–ù–∞–±–∏—Ä–∞–µ–º—Å—è —Å–∏–ª –ø–µ—Ä–µ–¥ —Ä–µ–π—Å–æ–º</div>
            `;
        }
    }

    function renderExpenses(cont) {
        let totals = dataCache.expenses.reduce((acc, ex) => {
            const amt = parseFloat(ex.Amount);
            acc[ex.Category] = (acc[ex.Category] || 0) + (ex.Currency === 'PLN' ? amt/exchangeRate : amt);
            return acc;
        }, {});

        cont.innerHTML = `
            <div class="card">
                <canvas id="expenseChart"></canvas>
            </div>
            <div id="expenseList"></div>
        `;

        const ctx = document.getElementById('expenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(totals),
                datasets: [{
                    data: Object.values(totals),
                    backgroundColor: ['#39CAB9', '#FFD700', '#FF4444', '#9C27B0', '#2196F3'],
                    borderWidth: 0
                }]
            },
            options: { plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
        });
        // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Å–ø–∏—Å–∫–∞ –∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–º –∫–æ–¥–µ
    }

    function renderCadences(cont) {
        // –õ–æ–≥–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ä–µ–π—Å–æ–≤ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        // ... (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç Net Profit –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫)
    }

    function exportToPDF() {
        if(TG.HapticFeedback) TG.HapticFeedback.impactOccurred('heavy');
        window.print();
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        render();
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('active');
        document.getElementById('overlay').style.display = 'none';
    }

    init();
</script>
</body>
</html>
